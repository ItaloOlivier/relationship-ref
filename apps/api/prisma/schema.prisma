generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH & USERS
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  magicLinks       MagicLink[]
  coupleAsPartner1 Couple[]          @relation("Partner1")
  coupleAsPartner2 Couple[]          @relation("Partner2")
  sessions         Session[]
  bankEntries      EmotionalBankEntry[]
  questProgress    QuestProgress[]
  streaks          Streak[]
  personalityProfile PersonalityProfile?

  @@map("users")
}

model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@map("magic_links")
}

// ============================================================================
// COUPLES
// ============================================================================

model Couple {
  id         String   @id @default(cuid())
  inviteCode String   @unique
  partner1Id String
  partner2Id String?
  partner1   User     @relation("Partner1", fields: [partner1Id], references: [id], onDelete: Cascade)
  partner2   User?    @relation("Partner2", fields: [partner2Id], references: [id], onDelete: SetNull)
  name       String?  // Optional couple name
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  sessions            Session[]
  bankLedger          EmotionalBankLedger?
  weeklyReports       WeeklyReport[]
  quests              Quest[]
  relationshipDynamic RelationshipDynamic?

  @@map("couples")
}

// ============================================================================
// SESSIONS & ANALYSIS
// ============================================================================

enum SessionStatus {
  RECORDING
  UPLOADED
  TRANSCRIBING
  ANALYZING
  COMPLETED
  FAILED
}

enum SessionSourceType {
  AUDIO           // Live recorded conversation
  WHATSAPP_CHAT   // Imported from WhatsApp export
}

model Session {
  id           String            @id @default(cuid())
  coupleId     String
  couple       Couple            @relation(fields: [coupleId], references: [id], onDelete: Cascade)
  initiatorId  String
  initiator    User              @relation(fields: [initiatorId], references: [id])
  status       SessionStatus     @default(RECORDING)
  sourceType   SessionSourceType @default(AUDIO)
  durationSecs Int?
  audioUrl     String?           // Only if user opted to retain audio
  retainAudio  Boolean           @default(false)
  transcript   String?           @db.Text
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  // WhatsApp import specific fields
  importedFileName    String?    // Original filename of imported chat
  importedMessageCount Int?      // Number of messages in imported chat
  chatParticipants    String[]   // Names extracted from chat export

  // Relations
  analysisResult      AnalysisResult?
  bankEntries         EmotionalBankEntry[]
  linguisticSnapshots LinguisticSnapshot[]

  @@index([coupleId])
  @@index([initiatorId])
  @@map("sessions")
}

enum CardType {
  GREEN
  YELLOW
  RED
}

model AnalysisResult {
  id        String   @id @default(cuid())
  sessionId String   @unique
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Scores
  overallScore     Int      // 0-100
  greenCardCount   Int      @default(0)
  yellowCardCount  Int      @default(0)
  redCardCount     Int      @default(0)
  bankChange       Int      @default(0) // Net emotional bank change

  // Detailed breakdown (JSON)
  cards            Json     // Array of { type, reason, timestamp?, quote? }
  horsemenDetected Json     // Array of detected horsemen patterns
  repairAttempts   Json     // Array of repair attempts detected
  topicTags        String[] // Conversation topics

  // Coaching output
  whatWentWell     String?  @db.Text
  tryNextTime      String?  @db.Text
  repairSuggestion String?  @db.Text

  // Safety flag
  safetyFlagTriggered Boolean @default(false)

  createdAt DateTime @default(now())

  @@map("analysis_results")
}

// ============================================================================
// EMOTIONAL BANK ACCOUNT
// ============================================================================

model EmotionalBankLedger {
  id        String   @id @default(cuid())
  coupleId  String   @unique
  couple    Couple   @relation(fields: [coupleId], references: [id], onDelete: Cascade)
  balance   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entries EmotionalBankEntry[]

  @@map("emotional_bank_ledgers")
}

enum BankEntryType {
  DEPOSIT
  WITHDRAWAL
}

model EmotionalBankEntry {
  id        String        @id @default(cuid())
  ledgerId  String
  ledger    EmotionalBankLedger @relation(fields: [ledgerId], references: [id], onDelete: Cascade)
  sessionId String?
  session   Session?      @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  userId    String?
  user      User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  type      BankEntryType
  amount    Int
  reason    String
  category  String        // e.g., "appreciation", "contempt", etc.
  createdAt DateTime      @default(now())

  @@index([ledgerId])
  @@map("emotional_bank_entries")
}

// ============================================================================
// GAMIFICATION
// ============================================================================

enum QuestType {
  DAILY
  WEEKLY
}

enum QuestStatus {
  ACTIVE
  COMPLETED
  EXPIRED
}

model Quest {
  id          String      @id @default(cuid())
  coupleId    String
  couple      Couple      @relation(fields: [coupleId], references: [id], onDelete: Cascade)
  type        QuestType
  status      QuestStatus @default(ACTIVE)
  title       String
  description String
  targetValue Int         @default(1) // e.g., "Complete 1 session"
  rewardPoints Int        @default(10)
  expiresAt   DateTime
  createdAt   DateTime    @default(now())
  completedAt DateTime?

  progress QuestProgress[]

  @@index([coupleId])
  @@map("quests")
}

model QuestProgress {
  id           String   @id @default(cuid())
  questId      String
  quest        Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentValue Int      @default(0)
  updatedAt    DateTime @updatedAt

  @@unique([questId, userId])
  @@map("quest_progress")
}

model Streak {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStreak Int     @default(0)
  longestStreak Int     @default(0)
  lastActivityDate DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId])
  @@map("streaks")
}

// ============================================================================
// REPORTS
// ============================================================================

model WeeklyReport {
  id        String   @id @default(cuid())
  coupleId  String
  couple    Couple   @relation(fields: [coupleId], references: [id], onDelete: Cascade)
  weekStart DateTime
  weekEnd   DateTime

  // Summary stats
  sessionCount     Int
  totalGreenCards  Int
  totalYellowCards Int
  totalRedCards    Int
  bankChangeNet    Int
  averageScore     Float

  // Insights (JSON)
  highlights       Json   // Array of positive highlights
  areasToImprove   Json   // Array of areas needing work
  weeklyTip        String? @db.Text

  createdAt DateTime @default(now())

  @@unique([coupleId, weekStart])
  @@map("weekly_reports")
}

// ============================================================================
// SCORING CONFIGURATION
// ============================================================================

model ScoringConfig {
  id       String @id @default(cuid())
  category String @unique // e.g., "appreciation", "contempt"
  points   Int
  cardType CardType?
  isActive Boolean @default(true)
  updatedAt DateTime @updatedAt

  @@map("scoring_configs")
}

// ============================================================================
// PERSONALITY PROFILES
// ============================================================================

// Big Five (OCEAN) traits - stored as 0-100 scores
// Attachment styles based on Bowlby/Ainsworth
// Communication patterns based on Satir model

enum AttachmentStyle {
  SECURE
  ANXIOUS_PREOCCUPIED
  DISMISSIVE_AVOIDANT
  FEARFUL_AVOIDANT
  UNDETERMINED
}

enum CommunicationStyle {
  PLACATER         // Agreeing, peace-keeping
  BLAMER           // Attacking, defensive
  COMPUTER         // Intellectual, detached
  DISTRACTER       // Deflecting, avoiding
  LEVELER          // Direct, authentic (healthy)
  MIXED            // No dominant pattern
}

model PersonalityProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Big Five (OCEAN) - 0 to 100 scale
  openness          Float?  // Curiosity, creativity, openness to experience
  conscientiousness Float?  // Organization, dependability, self-discipline
  extraversion      Float?  // Sociability, assertiveness, positive emotions
  agreeableness     Float?  // Cooperation, trust, empathy
  neuroticism       Float?  // Emotional instability, anxiety, moodiness

  // Attachment Style
  attachmentStyle   AttachmentStyle @default(UNDETERMINED)
  attachmentAnxiety Float?  // 0-100: fear of abandonment
  attachmentAvoidance Float? // 0-100: discomfort with closeness

  // Communication Style (Satir model)
  communicationStyle CommunicationStyle @default(MIXED)

  // Emotional Intelligence indicators
  emotionalAwareness Float?  // 0-100: recognition of own emotions
  empathyScore       Float?  // 0-100: recognition of partner's emotions
  emotionalRegulation Float? // 0-100: ability to manage emotional responses

  // Conflict patterns
  conflictStyle      String?  // "avoiding", "accommodating", "competing", "compromising", "collaborating"
  repairInitiation   Float?   // 0-100: tendency to initiate repairs
  repairReceptivity  Float?   // 0-100: receptivity to partner's repairs

  // Confidence scores for traits (how reliable the inference is)
  confidenceScore    Float    @default(0)  // 0-100: overall confidence in profile
  sessionsAnalyzed   Int      @default(0)  // Number of sessions used to build profile

  // AI-generated narrative descriptions
  strengthsNarrative String?  @db.Text
  growthAreasNarrative String? @db.Text
  communicationNarrative String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  snapshots LinguisticSnapshot[]

  @@map("personality_profiles")
}

// Stores raw linguistic features per session for evolution tracking
model LinguisticSnapshot {
  id        String   @id @default(cuid())
  profileId String
  profile   PersonalityProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Participant identifier within session (e.g., "John" from WhatsApp)
  participantName String

  // Word counts and ratios
  totalWords       Int
  uniqueWords      Int
  avgWordLength    Float
  avgSentenceLength Float

  // Pronoun usage (LIWC-style)
  firstPersonSingular Float  // I, me, my - self-focus
  firstPersonPlural   Float  // We, us, our - shared identity
  secondPerson        Float  // You, your - other-focus
  thirdPerson         Float  // He, she, they - distancing

  // Emotional language
  positiveEmotionWords Float  // love, happy, good
  negativeEmotionWords Float  // hate, angry, bad
  anxietyWords         Float  // worried, nervous, afraid
  angerWords           Float  // angry, hate, furious
  sadnessWords         Float  // sad, cry, disappointed

  // Cognitive patterns
  certaintyWords   Float  // always, never, definitely
  tentativeWords   Float  // maybe, perhaps, might
  discrepancyWords Float  // should, would, could (unmet expectations)

  // Social dynamics
  affiliationWords Float  // friend, together, share
  achievementWords Float  // win, success, better
  powerWords       Float  // control, force, superior

  // Communication markers
  questionFrequency Float  // Questions asked
  exclamationFrequency Float
  hedgingPhrases   Float  // "I think", "I feel like", "sort of"

  // Gottman patterns detected in this session
  criticismCount   Int @default(0)
  contemptCount    Int @default(0)
  defensivenessCount Int @default(0)
  stonewallingCount Int @default(0)

  // Repair attempts
  repairAttemptCount Int @default(0)
  repairSuccessRate Float?

  // Raw feature vector for ML (JSON blob)
  featureVector    Json?

  createdAt DateTime @default(now())

  @@unique([sessionId, participantName])
  @@index([profileId])
  @@map("linguistic_snapshots")
}

// Couple-level relationship dynamics
model RelationshipDynamic {
  id        String   @id @default(cuid())
  coupleId  String   @unique
  couple    Couple   @relation(fields: [coupleId], references: [id], onDelete: Cascade)

  // Interaction patterns
  pursuerWithdrawer   Boolean?  // Is there a pursuer-withdrawer dynamic?
  pursuerId           String?   // User ID of pursuer (if applicable)

  // Power balance
  conversationDominance Json?   // { "user1Id": 55, "user2Id": 45 } talk time %
  interruptionPattern   Json?   // Who interrupts whom more
  topicInitiation       Json?   // Who starts conversations/topics

  // Emotional reciprocity
  emotionalReciprocity Float?   // 0-100: balance of emotional labor
  validationBalance    Float?   // 0-100: mutual validation
  supportBalance       Float?   // 0-100: mutual support offered

  // Conflict patterns
  escalationTendency   Float?   // 0-100: how quickly conflicts escalate
  deescalationSkill    Float?   // 0-100: ability to calm conflicts
  resolutionRate       Float?   // 0-100: % of conflicts reaching resolution

  // Gottman ratios
  positiveToNegativeRatio Float? // 5:1 is healthy target

  // Strengths and growth areas (AI-generated)
  relationshipStrengths String[] // e.g., ["humor", "repair attempts", "appreciation"]
  growthOpportunities   String[] // e.g., ["active listening", "emotional validation"]

  // AI-generated insights
  dynamicNarrative      String?  @db.Text  // Accessible description of dynamics
  coachingFocus         String?  @db.Text  // What to work on together

  // Confidence and data
  confidenceScore       Float    @default(0)
  sessionsAnalyzed      Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("relationship_dynamics")
}
